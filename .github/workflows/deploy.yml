name: Deploy with Ansible

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers
    inputs:
      docker_image:
        description: 'Docker image to deploy'
        required: false
        default: 'danblanco/fastapi-cicd:latest'

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3 botocore
          ansible-galaxy collection install amazon.aws
          ansible-galaxy collection install community.docker
      
      - name: Install AWS Session Manager Plugin
        run: |
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
          sudo dpkg -i session-manager-plugin.deb
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Ansible
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Test AWS credentials
        run: |
          aws sts get-caller-identity
          aws ec2 describe-instances --filters "Name=tag:Environment,Values=dev" --query 'Reservations[*].Instances[*].[InstanceId,State.Name]' --output table
      
      - name: Test Ansible inventory
        run: |
          ansible-inventory --list -i playbooks/aws_ec2.yml
      
      - name: Run Ansible playbook
        run: |
          ansible-playbook playbooks/deploy.yml -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: false
      
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"

          echo "Target environment: dev"
